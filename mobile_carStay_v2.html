<!DOCTYPE html>
<html lang="en">

<head>
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>mobile_v8.2</title>
    <!-- leaflet -->
    <script src="https://unpkg.com/leaflet@1.2.0/dist/leaflet.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.2.0/dist/leaflet.css" />

    <!-- bootstrap -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- font-awesome -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css" rel="stylesheet">
    <link rel="stylesheet" href="./assets/css/map_css/map.css">
    <script src="./assets/js/BS5_js/bootstrap.min.js"></script>
    <!-- jQuery -->
    <script src="./assets/js/jquery-3.6.4.min.js"></script>
    <!-- routing machine -->
    <script src="./assets/js/map_control_js/leaflet-routing-machine-3.2.12/dist/leaflet-routing-machine.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine@latest/dist/leaflet-routing-machine.css" />
    <link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.1.0/css/font-awesome.min.css" rel="stylesheet">
    <link rel="stylesheet" href="./assets/css/map_control_css/leaflet-sidebar.css" />
    <!-- geasearch -->
    <link rel="stylesheet" href="./assets/css/map_control_css/geosearch.css">
    <script src="./assets/js/map_control_js/geosearch.umd.js"></script>
    <meta charset="UTF-8">
    <!-- Vue -->
    <script src="https://cdn.jsdelivr.net/npm/vue/dist/vue.js"></script>

    <style>
        body {
            margin: 0;
            padding: 0;
        }

        #map {
            width: 100%;
            height: 100vh;
            z-index: 0;
        }

        #topBar {
            z-index: 20;
            position: absolute;
            top: 0;
        }

        #searchBar {
            z-index: 15;
            position: absolute;
            top: 0;
        }

        #searchInfo {
            z-index: 15;
            position: absolute;
            bottom: 0;
        }

        #userPlaceBtn {
            position: absolute;
            right: 10px;
            top: 120px;
            z-index: 16;
            padding: 5px 5px 4px;
            border-radius: 50%;
            border: 0px;
            background-color: white;
            box-shadow: 0 0 5px gray;
        }

        #userPlaceBtn img {
            width: 30px;
        }

        #targetBtn {
            position: absolute;
            right: 10px;
            top: 180px;
            z-index: 16;
            padding: 5px 5px 4px;
            border-radius: 50%;
            border: 0px;
            background-color: white;
            box-shadow: 0 0 5px gray;
        }

        #targetBtn img {
            width: 30px;
        }
    </style>
</head>

<body>
    <!-- 導覽列 -->
    <div id="topBar">
        <div
            style="background-color: #0069B4; display: flex; justify-content: space-between; align-items: center; padding: 10px;width: 390px;">
            <div class="list" style="display: flex; align-items: center;">
                <span class="list-icon" onclick="toggleListMenu()"><i class="fas fa-bars"
                        style="color: white;cursor: pointer;"></i></span>
            </div>
            <div style="display: flex; align-items: center;">
                <span class="fa-stack fa-xl" style="margin-right: 15px;z-index: 99;" onclick="showDialog_info()">
                    <i class="far fa-circle fa-stack-1x" style="color: white;font-size: 1.5em;cursor: pointer;"></i>
                    <i class="fas fa-info fa-stack-1x fa-inverse" style="color: white;cursor: pointer;"></i>
                </span>
                <span class="fa-stack fa-xl" style="z-index: 99;">
                    <i id="redo" class="fas fa-redo fa-rotate-60" style="color: white;cursor: pointer;"></i>
                </span>
                <span class="fa-stack fa-xl" style="z-index: 99;">
                    <i class="fas fa-layer-group" style="color: white;cursor: pointer;" onclick="showDialog_map()"></i>
                </span>
            </div>
        </div>
        <!-- 下拉選單 -->
        <ul class="list-menu" style="display: none;z-index: 99;background-color: white;cursor: pointer;width: 100%;">

            <!-- <div class="d-grid  w-100" style="z-index: 99;">
                <button class="btn btn-primary border-0 w-100 navlist" type="button">Where my car !</button>
            </div> -->
            <div class="d-grid  w-100" style="z-index: 99;">
                <button class="btn btn-primary border-0 w-100 navlist" type="button">繳費紀錄</button>
            </div>

            <div class="d-grid  w-100" style="z-index: 99;">
                <button class="btn btn-primary border-0 w-100 navlist" type="button">付費車牌</button>
            </div>

            <!-- <div class="d-grid  w-100" style="z-index: 99;">
                <button class="btn btn-primary border-0 w-100 navlist" type="button">常用車位</button>
            </div> -->

            <div class="d-grid  w-100" style="z-index: 99;">
                <button class="btn btn-primary border-0 w-100 navlist" type="button">個人資訊</button>
            </div>
            <div class="d-grid  w-100" style="z-index: 99;">
                <button class="btn btn-primary border-0 w-100 navlist" type="button">付款方式</button>
            </div>
            <div class="d-grid  w-100" style="z-index: 99;">
                <button class="btn btn-primary border-0 w-100 navlist" type="button">通知中心</button>
            </div>
            <div class="d-grid  w-100" style="z-index: 99;">
                <button class="btn btn-primary border-0 w-100 navlist" type="button">登出</button>
            </div>
        </ul>
    </div>
    <!-- 覆蓋式視窗 -->
    <!-- 車位類型 -->
    <dialog id="Dialog_info">
        <div class="dialog-header">
            <h6 class="dialog-title">停車位類型</h6>
            <i class="fas fa-times fa-xs close-icon" onclick="closeDialog_info()"></i>
        </div>
        <div class="dialog_info_content">
            <br>
            <img src="./assets/image/map_image/parking_type.svg" alt="">

        </div>
        <br>

    </dialog>
    <!-- 地圖選擇 -->
    <dialog id="Dialog_map">
        <div class="dialog-header">
            <h6 class="dialog-title">地圖選擇</h6>
            <i class="fas fa-times fa-xs close-icon" onclick="closeDialog_map()"></i>
        </div>
        <div class="dialog_map_content">
            <img id="car_parking_img" class="map_select" src="./assets/image/map_image/car_parking_select.jpg" alt=""
                style="cursor: pointer;" onclick="">
            <img id="car_stay_img" class="map_select" src="./assets/image/map_image/car_stay.jpg" alt=""
                style="cursor: pointer;" onclick="window.location.href = './Mobile_v1_carStay.html';">
        </div>
    </dialog>

    <div id="searchBar">
        <!-- <div class="search-box">
            <i id="map_mark" class="fas fa-map-marker-alt "
                style="font-size: 1.1em;; color: rgba(128, 128, 128, 0.66);"></i>
            <input type="text" class="search-input border-0" placeholder="想去哪裡?">
            <i id="doSearch" class="btn fas border-0 fa-search"
                style="font-size: 1.1em; color: rgba(128, 128, 128, 0.66);"></i>
        </div> -->
        <div>
            <div id="filter">
                <label for="car_stay_type"></label>
                <select id="car_stay_type">
                    <option value="non_type">類型(不限)</option>
                    <option value="mooring_point">泊點</option>
                    <option value="stockroom">棧點</option>
                    <option value="camping">宿店-露營區</option>
                </select>
                <label for="service"></label>
                <select id="service">
                    <option value="non_parking_type">服務需求(不限)</option>
                    <option value="toilet">廁所</option>
                    <option value="hot_water">熱水</option>
                </select>
            </div>
        </div>
    </div>

    <div id="map"></div>

    <!-- track user place btn-->
    <button id="userPlaceBtn"><img src="./assets/image/map_control_img/user_place.png" alt=""> </button>

    <!-- 手風琴(開關式選單) -->
    <div class="sidebar" id="searchInfo">
        <button id="toggle-sidebar">
            <i class="fas fa-caret-down" style="color: #0069B4;"></i>
        </button>

        <br>

        <div id="parking_lot_item" class="accordion" id="accordion_map_list">
            <div class="accordion-item" v-for="(parking_name, index) in parkingLot" :key="index">
                <h2 class="accordion-header" id="headingOne">
                    <button class="accordion-button" type="button" v-on:click="toggleCollapse(parking_name.id)"
                        :class="{'collapsed': activeCollapse !== parking_name.id }"
                        :aria-expanded="activeCollapse === parking_name.id"
                        :aria-controls="'collapse-' + parking_name.id">
                        <div style="display: flex; flex-direction: column;">
                            <p class="parking_position">{{ parking_name.Position }}</p>
                        </div>
                        <div class="special-group">
                            <div id="ParkingTypeL" style="display: none;">{{parking_name.ParkingType}}</div>
                            <img v-if="parking_name.Type.includes(2)" id="Parent_Child"
                                src="./assets/image/map_image/Parent_Child.svg" style="margin: 2px;" alt="">
                            <img v-if="parking_name.Type.includes(1)" id="handicapped"
                                src="./assets/image/map_image/handicapped.svg" style="margin: 2px;" alt="">
                            <img v-if=" 1-(parking_name.AvailableCar/parking_name.TotalCar) < 0.3"
                                src="./assets/image/map_image/P-green.svg" style="margin: 2px;" alt="">
                            <img v-else-if="  1-(parking_name.AvailableCar/parking_name.TotalCar) >= 0.3 && 1-(parking_name.AvailableCar/parking_name.TotalCar) <= 0.6"
                                src="./assets/image/map_image/P-yellow.svg" style="margin: 2px;" alt="">
                            <img v-else src="./assets/image/map_image/P-red.svg" style="margin: 2px;" alt="">
                        </div>
                    </button>
                </h2>
                <div :id="'collapse-' + parking_name.id" class="accordion-collapse collapse"
                    :class="{'show': activeCollapse === parking_name.id }"
                    :aria-labelledby="'heading-' + parking_name.id" data-bs-parent="#accordion_map_list">
                    <div class="accordion-body">
                        <div id="list_detail">
                            <div id="number" style="display: flex; flex-direction: row;">
                                <p class="leftover">空車位：</p>
                                <p class="leafover_num">{{ parking_name.AvailableCar }}</p>
                                <p class="total_name">&nbsp;/&nbsp;總車位：</p>
                                <p class="total_num">{{ parking_name.TotalCar }}</p>
                            </div>
                            <div class="row">
                                <div id="update_info" class="col-8">
                                    <p class="up_time">更新時間：{{ parking_name.Updatetime }}</p>
                                </div>
                                <div id="distance_info" class="col-4">
                                    <p class="distance">{{ parking_name.distanceKM }}公里{{ parking_name.distanceM }}公尺
                                    </p>
                                    <p class="distance" style="display: none;">{{ parking_name.distance }}</p>
                                    <p class="distance_time">{{ parking_name.travelTime }} 分鐘</p>
                                </div>
                            </div>
                            <div id="lotX" style="display:none;">{{ parking_name.X }}</div>
                            <div id="lotY" style="display:none;">{{ parking_name.Y }}</div>

                            <div id="btn_group">
                                <img id="view_fee" class="btn" src="./assets/image/map_image/show_fee-btn.svg"
                                    @click="showDialog_fee(parking_name.Notes)" alt="">
                                <!-- <img id="like" class="btn" src="./assets/image/map_image/like_btn.svg" alt=""> -->
                                <img id="go" class="btn" src="./assets/image/map_image/go_btn.svg"
                                    @click="routing([parking_name.Y, parking_name.X])" alt="">
                            </div>
                            <div id="popular_time_graph" class="row">
                                <p class="col-12">熱門時段</p>
                                <img src="./assets/image/map_image/popular_time_graph.svg" alt="">
                            </div>
                        </div>
                    </div>
                </div>
                <!-- 收費資訊 -->
                <dialog :key="parking_name.id" id="Dialog_fee">
                    <div class="dialog-header">
                        <h6 class="dialog-title">收費方式</h6>
                        <i class="fas fa-times fa-xs close-icon" @click="closeDialog_fee()"></i>
                    </div>
                    <div class="dialog_fee_content">
                        <h6>{{dialog_fee_content}}</h6>
                    </div>
                </dialog>
            </div>
        </div>

        <!-- 使用 v-for 指令，遍歷 parkingRoad 陣列中的資料，並動態生成 HTML 標籤 -->
        <div id="parking_road_item" class="accordion" id="accordion_map_list">
            <div class="accordion-item" v-for="(parking, index) in parkingRoad" :key="index">
                <div class="accordion-item">
                    <h2 class="accordion-header" :class="{active: activeCollapse === index}"
                        @click="toggleCollapse(index)">


                        <button class="accordion-button" :class="{ collapsed: activeCollapse !== index }" type="button">
                            <p class="parking_name">{{ parking.rdname }}</p>
                            <p class="parking_subname"> ( {{ parking.se_road }} )</p>
                            <div class="special-group">

                                <div id="ParkingTypeR" style="display: none;">{{parking.ParkingType}}</div>
                                <img v-if="parking.PS_type === '1'" id="handicapped"
                                    src="./assets/image/map_image/handicapped.svg" style="margin: 2px;" alt="">
                                <img v-if="parking.PS_type === '2'" id="Parent_Child"
                                    src="./assets/image/map_image/Parent_Child.svg" style="margin: 2px;" alt="">
                                <span v-if="parking.PS_type === '0'" style="margin: 2px;" alt="">&nbsp;</span>

                                <img v-if="parking.status === '0'" id="status_light"
                                    src="./assets/image/map_image/Vector_green.svg" style="margin: 4.2px;" alt="">
                                <img v-else src="./assets/image/map_image/Vector_red.svg" style="margin: 4.2px;" alt="">
                            </div>
                        </button>
                    </h2>
                    <div :id="'collapse' + index" class="accordion-collapse collapse"
                        :class="{show: activeCollapse === index}">
                        <div class="accordion-body">
                            <div id="load_addr">
                                <p>車格編號：{{ parking.ceiiId }}</p>
                            </div>
                            <div class="row">
                                <div id="update_info" class="col-8">
                                    <p class="up_time">更新時間：{{ parking.Updatetime }}</p>
                                </div>
                                <div id="distance_info" class="col-4">
                                    <p class="distance">{{ parking.distanceKM }}公里{{ parking.distanceM }}公尺</p>
                                    <p class="distance" style="display: none;">{{ parking.distance }}</p>
                                    <p class="distance_time">{{ parking.travelTime }}分鐘</p>
                                </div>
                            </div>
                            <div id="roadX" style="display:none;">{{ parking.TWD97_X }}</div>
                            <div id="roadY" style="display:none;">{{ parking.TWD97_Y }}</div>

                            <img id="view_fee" class="btn" src="./assets/image/map_image/show_fee-btn.svg"
                                @click="showDialog_roadfee(parking.paycash)" alt="">
                            <!-- <img id="like" class="btn" src="./assets/image/map_image/like_btn.svg" alt=""> -->
                            <img id="go" class="btn" src="./assets/image/map_image/go_btn.svg"
                                @click="routingTest([parking.TWD97_Y, parking.TWD97_X])" alt="">
                        </div>
                    </div>
                </div>
                <!-- 收費資訊 -->
                <dialog :key="parking.id" id="Dialog_road_fee">
                    <div class="dialog-header">
                        <h6 class="dialog-title">收費方式</h6>
                        <i class="fas fa-times fa-xs close-icon" @click="closeDialog_roadfee()"></i>
                    </div>
                    <div class="dialog_fee_content">
                        <h6>{{dialog_roadfee_content}}</h6>
                    </div>
                </dialog>
            </div>
        </div>
        <br><br><br><br><br><br><br><br><br><br>
        <!-- Add more accordion items here -->

    </div>



    <script>
        //地圖顯示相關設定
        let zoom = 15; // 0 - 18
        let center = [24.137508915419836, 120.68694731120945]; // 中心點座標
        let map = L.map('map').setView(center, zoom);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '© OpenStreetMap', // 商用時必須要有版權出處
            maxZoom: 18,
            layerLimit: 20, // 設定顯示圖層數量上限為 20
            zoomControl: true, // 是否秀出 - + 按鈕
        }).addTo(map);
        // remove zoomControl
        map.zoomControl.remove();

        // 設定icon
        // 泊點icon
        var sleep = L.icon({ //add this new icon
            iconUrl: './assets/image/map_control_img/sleep.png',
            iconSize: [40, 40], // size of the icon
        });
        // 棧點icon
        var rest = L.icon({
            iconUrl: './assets/image/map_control_img/bus.png',
            iconSize: [40, 40],
        });
        // 露營區icon
        var camping = L.icon({
            iconUrl: './assets/image/map_control_img/camping.png',
            iconSize: [40, 40],
        });
        // user icon
        var userIcon = L.icon({
            iconUrl: './assets/image/map_control_img/user_place.png',
            iconSize: [40, 40],
        });
        // search icon
        var searchIcon = L.icon({
            iconUrl: './assets/image/map_control_img/Target.png',
            iconSize: [35, 40],
        });


        // 標籤匯入class
        let parkingClass = (markClass, className) => {
            let mark = markClass.closePopup();
            mark._icon.classList.add(className);
        }

        // 標籤屬性匯入提示窗
        function inputInfo(parkDct, marker) {
            marker.bindPopup(`
                <b>${parkDct['cs_name']}</b><br>
                類型：${parkDct['cs_type']}
                ${parkDct['cs_water'] == 1 ? '<img src="./assets/image/map_image/hotWater.png" style="margin: 2px;width: 35px" alt="">' : ''}
                ${parkDct['cs_toilet'] == 1 ? '<img src="./assets/image/map_image/toilet.png" style="margin: 2px;width: 35px" alt="">' : ''}<br>
            `)
        }


        // 取得使用者點位
        navigator.geolocation.watchPosition(success, error);

        // geosearch(搜尋bar) 
        const search = new GeoSearch.GeoSearchControl({
            provider: new GeoSearch.OpenStreetMapProvider(),
            style: 'bar',
            showMarker: false,
            // marker: searchPlace,
        });
        map.addControl(search);

        $.ajax({
            url: "http://localhost:3000/select/carstay/",
            type: "GET"
        }).done(function (x) {
            var datafromS = JSON.parse(x);
            $(datafromS).each(function (index, carStayData) {
                console.log(carStayData)
                switch (carStayData['cs_type']) {
                    case '棧點':
                        if (carStayData['cs_toilet'] == '1') {
                            var restToilet = L.marker([carStayData['cs_lat'], carStayData['cs_lng']], { icon: rest }).addTo(map);
                            inputInfo(carStayData, restToilet);
                            parkingClass(restToilet, 'restToilet');
                        } else if (carStayData['cs_water'] == '1') {
                            var restWater = L.marker([carStayData['cs_lat'], carStayData['cs_lng']], { icon: rest }).addTo(map);
                            inputInfo(carStayData, restWater);
                            parkingClass(restWater, 'restWater');
                        } else {
                            var restNon = L.marker([carStayData['cs_lat'], carStayData['cs_lng']], { icon: rest }).addTo(map);
                            inputInfo(carStayData, restNon);
                            parkingClass(restNon, 'restNon');
                        }
                        break;

                    case '泊點':
                        if (carStayData['cs_toilet'] == '1') {
                            var sleepToilet = L.marker([carStayData['cs_lat'], carStayData['cs_lng']], { icon: sleep }).addTo(map);
                            inputInfo(carStayData, sleepToilet);
                            parkingClass(sleepToilet, 'sleepToilet');
                        } else if (carStayData['cs_water'] == '1') {
                            var sleepWater = L.marker([carStayData['cs_lat'], carStayData['cs_lng']], { icon: sleep }).addTo(map);
                            inputInfo(carStayData, sleepWater);
                            parkingClass(sleepWater, 'sleepWater');
                        } else {
                            var sleepNon = L.marker([carStayData['cs_lat'], carStayData['cs_lng']], { icon: sleep }).addTo(map);
                            inputInfo(carStayData, sleepNon);
                            parkingClass(sleepNon, 'sleepNon');
                        }
                        break;
                    default:
                        if (carStayData['cs_toilet'] == '1') {
                            var campingToilet = L.marker([carStayData['cs_lat'], carStayData['cs_lng']], { icon: camping }).addTo(map);
                            inputInfo(carStayData, campingToilet);
                            parkingClass(campingToilet, 'campingToilet');
                        } else if (carStayData['cs_water'] == '1') {
                            var campingWater = L.marker([carStayData['cs_lat'], carStayData['cs_lng']], { icon: camping }).addTo(map);
                            inputInfo(carStayData, campingWater);
                            parkingClass(campingWater, 'campingWater');
                        } else {
                            var campingNon = L.marker([carStayData['cs_lat'], carStayData['cs_lng']], { icon: camping }).addTo(map);
                            inputInfo(carStayData, campingNon);
                            parkingClass(campingNon, 'campingNon');
                        }
                        break;
                }
            })
        })



        let usermarker, userZoomed, userlat, userlng, searchlat, searchlng, searchmarker;
        map.on('geosearch/showlocation', function (e) {
            searchlat = e.location.y;
            searchlng = e.location.x;
            // reset marker and circle
            if (searchmarker) {
                map.removeLayer(searchmarker);
                // map.removeLayer(userCircle);
            }
            // add search marker
            searchmarker = L.marker([e.location.y, e.location.x], { icon: searchIcon }).addTo(map);

        });
        // 提示未啟用導航
        function error(err) {
            if (err.code === 1) {
                alert("無法獲得位置資訊，請開啟定位功能或使用搜尋欄搜尋您所在地點");
            } else {
                alert('已啟用定位功能')
            }
        }

        function success(pos, area = $('#distance_select').val(), parkType = $('#type_select').val()) {
            userlat = pos.coords.latitude;
            userlng = pos.coords.longitude;
            // reset marker and circle
            if (usermarker) {
                map.removeLayer(usermarker);
            }
            // add user marker
            usermarker = L.marker([userlat, userlng], { icon: userIcon }).addTo(map);

            // userplace callback
            addUserPlace(area, parkType, userlat, userlng);

        }

        // userplace function
        addUserPlace = (area, parkType, userlat, userlng) => {

            $('#userPlaceBtn').on('click', function () {
                map.setView([userlat, userlng], 15);
            })

        }

        // change car_stay_type
        $('#car_stay_type').change(function () {
            switch ($(this).val()) {
                case "mooring_point":
                    $(".sleepToilet").show();
                    $(".sleepWater").show();
                    $(".sleepNon").show();
                    $('.restToilet').hide();
                    $('.restWater').hide();
                    $('.restNon').hide();
                    $('.campingToilet').hide();
                    $('.campingWater').hide();
                    $('.campingNon').hide();
                    switch ($('#service').val()) {
                        case "toilet":
                            $(".sleepWater").hide();
                            $(".sleepNon").hide();
                            $('.restToilet').hide();
                            $('.restWater').hide();
                            $('.restNon').hide();
                            $('.campingToilet').hide();
                            $('.campingWater').hide();
                            $('.campingNon').hide();
                            break;
                        case "hot_water":
                            $(".sleepToilet").hide();
                            $(".sleepNon").hide();
                            $('.restToilet').hide();
                            $('.restWater').hide();
                            $('.restNon').hide();
                            $('.campingToilet').hide();
                            $('.campingWater').hide();
                            $('.campingNon').hide();
                            break;
                        default:
                            break;
                    }
                    break;
                case "stockroom":
                    $(".sleepToilet").hide();
                    $(".sleepWater").hide();
                    $(".sleepNon").hide();
                    $('.restToilet').show();
                    $('.restWater').show();
                    $('.restNon').show();
                    $('.campingToilet').hide();
                    $('.campingWater').hide();
                    $('.campingNon').hide();
                    switch ($('#service').val()) {
                        case "toilet":
                            $('.restWater').hide();
                            $('.restNon').hide();
                            break;
                        case "hot_water":
                            $('.restToilet').hide();
                            $('.restNon').hide();
                            break;
                        default:
                            break;
                    }
                    break;
                case "camping":
                    $(".sleepToilet").hide();
                    $(".sleepWater").hide();
                    $(".sleepNon").hide();
                    $('.restToilet').hide();
                    $('.restWater').hide();
                    $('.restNon').hide();
                    $('.campingToilet').show();
                    $('.campingWater').show();
                    $('.campingNon').show();
                    switch ($('#service').val()) {
                        case "toilet":
                            $(".sleepToilet").hide();
                            $(".sleepWater").hide();
                            $(".sleepNon").hide();
                            $('.restToilet').hide();
                            $('.restWater').hide();
                            $('.restNon').hide();
                            $('.campingWater').hide();
                            $('.campingNon').hide();
                            break;
                        case "hot_water":
                            $(".sleepToilet").hide();
                            $(".sleepWater").hide();
                            $(".sleepNon").hide();
                            $('.restToilet').hide();
                            $('.restWater').hide();
                            $('.restNon').hide();
                            $('.campingToilet').hide();
                            $('.campingNon').hide();
                            break;
                        default:
                            break;
                    }
                    break;
                default:
                    $(".sleepToilet").show();
                    $(".sleepWater").show();
                    $(".sleepNon").show();
                    $('.restToilet').show();
                    $('.restWater').show();
                    $('.restNon').show();
                    $('.campingToilet').show();
                    $('.campingWater').show();
                    $('.campingNon').show();
                    switch ($('#service').val()) {
                        case "toilet":
                            $(".sleepWater").hide();
                            $(".sleepNon").hide();
                            $('.restWater').hide();
                            $('.restNon').hide();
                            $('.campingWater').hide();
                            $('.campingNon').hide();
                            break;
                        case "hot_water":
                            $(".sleepToilet").hide();
                            $(".sleepNon").hide();
                            $('.restToilet').hide();
                            $('.restNon').hide();
                            $('.campingToilet').hide();
                            $('.campingNon').hide();
                            break;
                        default:
                            break;
                    }
                    break;
            }
        })

        // change service type
        $('#service').change(function () {
            switch ($(this).val()) {
                case "toilet":
                    $(".sleepToilet").show();
                    $(".sleepWater").hide();
                    $(".sleepNon").hide();
                    $('.restToilet').show();
                    $('.restWater').hide();
                    $('.restNon').hide();
                    $('.campingToilet').show();
                    $('.campingWater').hide();
                    $('.campingNon').hide();
                    switch ($('#car_stay_type').val()) {
                        case "mooring_point":
                            $(".sleepWater").hide();
                            $(".sleepNon").hide();
                            $('.restToilet').hide();
                            $('.restWater').hide();
                            $('.restNon').hide();
                            $('.campingToilet').hide();
                            $('.campingWater').hide();
                            $('.campingNon').hide();
                            break;
                        case "stockroom":
                            $(".sleepToilet").hide();
                            $(".sleepWater").hide();
                            $(".sleepNon").hide();
                            $('.restToilet').show();
                            $('.restWater').hide();
                            $('.restNon').hide();
                            $('.campingToilet').hide();
                            $('.campingWater').hide();
                            $('.campingNon').hide();
                            break;
                        case "camping":
                            $(".sleepToilet").hide();
                            $(".sleepWater").hide();
                            $(".sleepNon").hide();
                            $('.restToilet').hide();
                            $('.restWater').hide();
                            $('.restNon').hide();
                            $('.campingWater').hide();
                            $('.campingNon').hide();
                            break;
                        default:
                            break;
                    }
                    break;
                case "hot_water":
                    $(".sleepToilet").hide();
                    $(".sleepWater").show();
                    $(".sleepNon").hide();
                    $('.restToilet').hide();
                    $('.restWater').show();
                    $('.restNon').hide();
                    $('.campingToilet').hide();
                    $('.campingWater').show();
                    $('.campingNon').hide();
                    switch ($('#car_stay_type').val()) {
                        case "mooring_point":
                            $(".sleepToilet").hide();
                            $(".sleepNon").hide();
                            $('.restToilet').hide();
                            $('.restWater').hide();
                            $('.restNon').hide();
                            $('.campingToilet').hide();
                            $('.campingWater').hide();
                            $('.campingNon').hide();
                            break;
                        case "stockroom":
                            $(".sleepToilet").hide();
                            $(".sleepWater").hide();
                            $(".sleepNon").hide();
                            $('.restToilet').hide();
                            $('.restWater').show();
                            $('.restNon').hide();
                            $('.campingToilet').hide();
                            $('.campingWater').hide();
                            $('.campingNon').hide();
                            break;
                        case "camping":
                            $(".sleepToilet").hide();
                            $(".sleepWater").hide();
                            $(".sleepNon").hide();
                            $('.restToilet').hide();
                            $('.restWater').hide();
                            $('.restNon').hide();
                            $('.campingToilet').hide();
                            $('.campingNon').hide();
                            break;
                        default:
                            break;
                    }
                    break;

                default:
                    $(".sleepToilet").show();
                    $(".sleepWater").show();
                    $(".sleepNon").show();
                    $('.restToilet').show();
                    $('.restWater').show();
                    $('.restNon').show();
                    $('.campingToilet').show();
                    $('.campingWater').show();
                    $('.campingNon').show();
                    switch ($('#car_stay_type').val()) {
                        case "mooring_point":
                            $('.restToilet').hide();
                            $('.restWater').hide();
                            $('.restNon').hide();
                            $('.campingToilet').hide();
                            $('.campingWater').hide();
                            $('.campingNon').hide();
                            break;
                        case "stockroom":
                            $(".sleepToilet").hide();
                            $(".sleepWater").hide();
                            $(".sleepNon").hide();
                            $('.campingToilet').hide();
                            $('.campingWater').hide();
                            $('.campingNon').hide();
                            break;
                        case "camping":
                            $(".sleepToilet").hide();
                            $(".sleepWater").hide();
                            $(".sleepNon").hide();
                            $('.restToilet').hide();
                            $('.restWater').hide();
                            $('.restNon').hide();
                            break;
                        default:
                            break;
                    }
                    break;
            }
        })


        // function refrash_road(cur_area) {
        //     // console.log(cur_area);
        //     $('.roadOkDisabled').remove();
        //     $('.roadNonDisabled').remove();
        //     $('.roadOkParents').remove();
        //     $('.roadNonParents').remove();
        //     $('.roadOkNormal').remove();
        //     $('.roadNonNormal').remove();
        //     let a = 0;
        //     a = cur_area;
        //     let car_parking_url = "https://datacenter.taichung.gov.tw/Swagger/OpenData/791a8a4b-ade6-48cf-b3ed-6c594e58a1f1";
        //     let car_parking_xhr = new XMLHttpRequest();
        //     car_parking_xhr.open('GET', car_parking_url, true);
        //     car_parking_xhr.send();
        //     car_parking_xhr.onreadystatechange = function () {
        //         if (this.readyState === 4 && this.status === 200) {
        //             response = JSON.parse(this.response);
        //             // console.log(response);
        //             $(response).each(function (i, parkInfo) {
        //                 var roadlat = Number(parkInfo['PS_Lat']);
        //                 var roadlng = Number(parkInfo['PS_Lng']);
        //                 switch (parkInfo['PS_type']) {
        //                     case '1':
        //                         if (L.latLng(userlat, userlng).distanceTo(L.latLng(roadlat, roadlng)) < a) {
        //                             if (parkInfo['status'] == 0) {
        //                                 targetPoint.push([roadlat, roadlng]);
        //                                 targetDis.push(L.latLng(userlat, userlng).distanceTo(L.latLng(roadlat, roadlng)));
        //                                 var markerOK = L.marker([parkInfo['PS_Lat'], parkInfo['PS_Lng']], { icon: parkOk }).addTo(map);
        //                                 parkingClass(markerOK, 'roadOkDisabled');
        //                             } else {
        //                                 var markerNon = L.marker([parkInfo['PS_Lat'], parkInfo['PS_Lng']], { icon: parkNon }).addTo(map);
        //                                 parkingClass(markerNon, 'roadNonDisabled');
        //                             }
        //                         }
        //                         break;
        //                     case '2':
        //                         if (L.latLng(userlat, userlng).distanceTo(L.latLng(roadlat, roadlng)) < a) {
        //                             if (parkInfo['status'] == 0) {
        //                                 targetPoint.push([roadlat, roadlng]);
        //                                 targetDis.push(L.latLng(userlat, userlng).distanceTo(L.latLng(roadlat, roadlng)))
        //                                 var markerOK = L.marker([parkInfo['PS_Lat'], parkInfo['PS_Lng']], { icon: parkOk }).addTo(map);
        //                                 parkingClass(markerOK, 'roadOkParents');
        //                             } else {
        //                                 var markerNon = L.marker([parkInfo['PS_Lat'], parkInfo['PS_Lng']], { icon: parkNon }).addTo(map);
        //                                 parkingClass(markerNon, 'roadNonParents');
        //                             }
        //                         }
        //                         break;
        //                     default:
        //                         if (L.latLng(userlat, userlng).distanceTo(L.latLng(roadlat, roadlng)) < a) {
        //                             if (parkInfo['status'] == 0) {
        //                                 targetPoint.push([roadlat, roadlng]);
        //                                 targetDis.push(L.latLng(userlat, userlng).distanceTo(L.latLng(roadlat, roadlng)))
        //                                 var markerOK = L.marker([parkInfo['PS_Lat'], parkInfo['PS_Lng']], { icon: parkOk }).addTo(map);
        //                                 parkingClass(markerOK, 'roadOkNormal');
        //                             } else {
        //                                 var markerNon = L.marker([parkInfo['PS_Lat'], parkInfo['PS_Lng']], { icon: parkNon }).addTo(map);
        //                                 parkingClass(markerNon, 'roadNonNormal');
        //                             }
        //                         }
        //                         break;
        //                 }
        //                 // if (L.latLng(userlat, userlng).distanceTo(L.latLng(roadlat, roadlng)) < a) {
        //                 //     if (parkInfo['status'] == 0) {
        //                 //         var markerOK = L.marker([parkInfo['PS_Lat'], parkInfo['PS_Lng']], { icon: parkOk }).addTo(map);
        //                 //         parkingClass(markerOK, 'road_ok');
        //                 //     } else {
        //                 //         var markerNon = L.marker([parkInfo['PS_Lat'], parkInfo['PS_Lng']], { icon: parkNon }).addTo(map);
        //                 //         parkingClass(markerNon, 'road_non');
        //                 //     }
        //                 // }
        //             })
        //         };
        //     }
        // }

    </script>

    <script>
        const $sidebar = $(".sidebar");
        const $toggleSidebarButton = $("#toggle-sidebar");
        let isSidebarOpen = true;
        let isListMenuOpen = false;

        $toggleSidebarButton.click(() => {
            if (!isListMenuOpen) {
                $sidebar.toggleClass("collapsed");
                $toggleSidebarButton.toggleClass("collapsed");
                isSidebarOpen = !isSidebarOpen;

                $("body").css("overflow", isSidebarOpen ? "overflow" : "hidden");
                $sidebar.css("overflow", isSidebarOpen ? "scroll" : "auto");

                if (isSidebarOpen) {
                    $sidebar.css("transition", "none");
                    setTimeout(() => $sidebar.css("transition", "overflow 1.0s ease-in-out"), 0);
                } else {
                    $sidebar.css("transition", "");
                }
            }
        });

        function toggleListMenu() {
            var listMenu = document.querySelector(".list-menu");
            if (listMenu.style.display === "none") {
                listMenu.style.display = "grid";
                isListMenuOpen = true;
            } else {
                listMenu.style.display = "none";
                isListMenuOpen = false;
            }
            $("body").css("overflow", isListMenuOpen ? "hidden" : "auto");
        }

        // 取得所有accordion的元素
        const accordions = document.querySelectorAll('.accordion-button');

        // 為每個accordion設置點擊事件監聽器
        accordions.forEach(accordion => {
            accordion.addEventListener('click', () => {
                // 檢查sidebar是否已收合
                const sidebar = document.querySelector('.sidebar');
                const toggleSidebarButton = document.querySelector('#toggle-sidebar');
                if (sidebar.classList.contains('collapsed')) {
                    // 展開sidebar
                    sidebar.classList.remove('collapsed');
                    toggleSidebarButton.classList.remove('collapsed');
                }
            });
        });


        //當userPlaceBtn點擊時收合操作面板
        const userPlaceBtn = document.getElementById('userPlaceBtn');
        userPlaceBtn.addEventListener('click', () => {

            // 檢查sidebar是否已收合
            const sidebar = document.querySelector('.sidebar');
            const toggleSidebarButton = document.querySelector('#toggle-sidebar');
            if (!sidebar.classList.contains('collapsed')) {
                // 展開sidebar
                sidebar.classList.add('collapsed');
                toggleSidebarButton.classList.add('collapsed');
            }
        })





        // 控制對話框
        function showDialog_info() {
            document.getElementById("Dialog_info").showModal();
        }

        function closeDialog_info() {
            document.getElementById("Dialog_info").close();
        }

        function showDialog_map() {
            document.getElementById("Dialog_map").showModal();
        }
        function closeDialog_map() {
            document.getElementById("Dialog_map").close();
        }



        //圖層切換icon
        // 取得圖像元素
        const carParkingImg = document.getElementById("car_parking_img");
        const carStayImg = document.getElementById("car_stay_img");

        // 為每個圖像添加點擊事件監聽器
        carParkingImg.addEventListener("click", toggleCarParkingImg);
        carStayImg.addEventListener("click", toggleCarStayImg);

        function toggleCarParkingImg() {
            // 切換選擇和未選擇圖像
            if (!carParkingImg.src.includes("_select")) {
                carParkingImg.src = "./assets/image/map_image/car_parking_select.jpg"
            }
            carStayImg.src = "./assets/image/map_image/car_stay.jpg";
        }

        function toggleCarStayImg() {
            // 切換選擇和未選擇圖像
            if (!carStayImg.src.includes("_select")) {
                carStayImg.src = "./assets/image/map_image/car_stay_select.jpg"
            }
            carParkingImg.src = "./assets/image/map_image/car_parking.jpg";
        }

        // 手動更新清單的提示訊息
        const redo = document.getElementById('redo');

        redo.addEventListener('click', () => {
            // 顯示訊息
            const message = document.createElement('div');
            message.innerText = '已更新清單資訊';
            message.style.position = 'fixed';
            message.style.top = '50%';
            message.style.left = '50%';
            message.style.transform = 'translate(-50%, -50%)';
            message.style.padding = '10px 20px';
            message.style.backgroundColor = 'rgba(0, 0, 0, 0.7)';
            message.style.color = '#fff';
            message.style.borderRadius = '5px';
            message.style.zIndex = 9999;
            document.body.appendChild(message);

            // 關閉訊息
            setTimeout(() => {
                message.remove();
            }, 700);
        });


        // 加入最愛的提示訊息
        const likeBtns = document.querySelectorAll('#like');
        likeBtns.forEach(likeBtn => {
            likeBtn.addEventListener('click', () => {
                // 顯示訊息
                const message = document.createElement('div');
                message.innerText = '已加到最愛清單';
                message.style.position = 'fixed';
                message.style.top = '50%';
                message.style.left = '50%';
                message.style.transform = 'translate(-50%, -50%)';
                message.style.padding = '10px 20px';
                message.style.backgroundColor = 'rgba(0, 0, 0, 0.7)';
                message.style.color = '#fff';
                message.style.borderRadius = '5px';
                message.style.zIndex = 9999;
                document.body.appendChild(message);

                // 關閉訊息
                setTimeout(() => {
                    message.remove();
                }, 700);
            });
        });
    </script>
    <script>

        // 取得台中停車場資訊
        let taichung_parking_url = "https://motoretag.taichung.gov.tw/DataAPI/api/ParkingSpotListAPI";
        let taichung_parking_xhr = new XMLHttpRequest();


        // 定義 parkingLot 陣列在全域範圍
        const parkingLot = [];

        //台中停車場資訊
        function fetchParkingData(url) {
            return fetch(url)
                .then(response => response.json())
                .then(parking_data => {
                    const parkingLot_info = {};
                    parking_data.forEach(parking => {
                        parking.ParkingLots.forEach(lot => {
                            if (lot.AvailableCar >= 0 && lot.Position != null) {
                                let distance = parseInt(L.latLng(userlat, userlng).distanceTo(L.latLng(lot.Y, lot.X)));
                                let travTime = parseInt(distance / 30000 * 60);
                                parkingLot_info[lot.ID] = {
                                    id: lot.ID,
                                    Position: lot.Position,
                                    X: lot.X,
                                    Y: lot.Y,
                                    AvailableCar: lot.AvailableCar,
                                    TotalCar: lot.TotalCar,
                                    Type: lot.Type,
                                    Notes: lot.Notes,
                                    "ParkingType": 'ParkingLot',
                                    Updatetime: lot.Updatetime,
                                    distance: distance,
                                    distanceKM: parseInt(distance / 1000),
                                    distanceM: distance - (1000 * parseInt(distance / 1000)),
                                    travelTime: travTime
                                };
                            }
                        });
                    });
                    // 在這裡將 parkingLot_info 賦值給全域範圍的 parkingLot 陣列
                    for (let key in parkingLot_info) {
                        parkingLot.push(parkingLot_info[key]);
                    }
                })
                .catch(error => console.error(error));
        }

        // 在需要時呼叫fetchParkingData函數
        fetchParkingData(taichung_parking_url)
            .then(() => {
                var parkingLotVue = new Vue({
                    el: '#parking_lot_item',
                    data: {
                        parkingLot,
                        activeCollapse: null, // 當前展開的折疊區塊ID
                        dialog_fee_content: "" // 對話框內容
                    },
                    methods: {
                        toggleCollapse: function (id) {
                            // 如果點擊的是已經展開的選項，則關閉它
                            if (this.activeCollapse === id) {
                                this.activeCollapse = null;
                            }
                            // 如果點擊的是折疊的選項，則展開它
                            else {
                                this.activeCollapse = id;
                            }
                        },
                        showDialog_fee(notes) {
                            this.dialog_fee_content = notes;
                            document.getElementById("Dialog_fee").showModal();
                        },
                        closeDialog_fee() {
                            document.getElementById("Dialog_fee").close();
                        },
                        // 導航功能
                        routing(routeLatLng) {
                            // 導向google導航網頁
                            var url = 'https://www.google.com/maps/dir/?api=1&destination=' + routeLatLng[0] + ',' + routeLatLng[1];
                            window.open(url);
                        }
                    }
                })
                // 在這裡使用parkingLot
                // console.log(parkingLot);
            })
            .then(() => {
                // 在選單改變時觸發事件
                document.getElementById("special_select").addEventListener("change", function () {
                    var selectedValue = this.value; // 取得目前選擇的值
                    var parkingItems = document.querySelectorAll("#parking_lot_item .accordion-item"); // 取得所有停車場項目

                    // 依據選擇的值顯示相對應的停車場項目
                    for (var i = 0; i < parkingItems.length; i++) {
                        var parkingItem = parkingItems[i];
                        var parkingName = parkingItem.querySelector(".parking_position").textContent;
                        var parkingType = parkingLot.find(function (item) { return item.Position === parkingName; }).Type;

                        // 顯示所有停車場
                        if (selectedValue === "non_special") {
                            parkingItem.style.display = "block";
                        }
                        // 顯示身障車位
                        else if (selectedValue === "disabled" && parkingType.includes(1)) {
                            parkingItem.style.display = "block";
                        }
                        // 顯示親子車位
                        else if (selectedValue === "parent" && parkingType.includes(2)) {
                            parkingItem.style.display = "block";
                        }
                        // 隱藏其它類型的停車場
                        else {
                            parkingItem.style.display = "none";
                        }
                    }
                });
            })

        // --------------------------------------------------------------

        //台中路邊停車格資訊 --v2

        // 定義 parkingRoad 陣列在全域範圍
        const parkingRoad = [];
        const now = new Date();
        now.setHours(now.getHours() + 8);

        // 創建一個函數，用於從 CSV 字串中解析 JSON 物件
        function parseTaichungRoadInfo(csvString) {
            return csvString.split('\r\n').map(row => {
                let distance, travTime
                const values = row.split(',');
                if (values[10] !== undefined) {
                    distance = parseInt(L.latLng(userlat, userlng).distanceTo(L.latLng(values[10], values[9])));
                    travTime = parseInt(distance / 30000 * 60);
                } else {
                    distance = null;
                    travTime = null;
                }
                return {
                    id: values[0],
                    road_id: values[2],
                    rdname: values[3],
                    se_road: values[4],
                    ceiiId: values[5],
                    paycash: values[7],
                    PS_type: values[8],
                    TWD97_X: values[9],
                    TWD97_Y: values[10],
                    status: values[11],
                    distance: distance,
                    distanceKM: parseInt(distance / 1000),
                    distanceM: distance - (1000 * parseInt(distance / 1000)),
                    travelTime: travTime,
                    "ParkingType": 'ParkingRoad',
                    Updatetime: now.toISOString().replace('T', ' ').substr(0, 19)
                };
            });
        }

        // 調用 parseTaichungRoadInfo 函數來解析 CSV 字串並取得我們需要的屬性
        fetch('./assets/image/map_image/taichung_road_info/taichung_road_parking_info.csv')
            .then(response => response.text())
            .then(csvString => {
                const taichung_road_info = parseTaichungRoadInfo(csvString);
                for (let i = 0; i < 100; i++) { //taichung_road_info.length
                    parkingRoad.push(taichung_road_info[i]);
                }

                var parkingRoadVue = new Vue({
                    el: '#parking_road_item',
                    data: {
                        parkingRoad,
                        activeCollapse: null,
                        dialog_roadfee_content: "" // 對話框內容
                    },
                    methods: {
                        toggleCollapse: function (id) {
                            // 如果點擊的是已經展開的選項，則關閉它
                            if (this.activeCollapse === id) {
                                this.activeCollapse = null;
                            }
                            // 如果點擊的是折疊的選項，則展開它
                            else {
                                this.activeCollapse = id;
                            }
                        },
                        showDialog_roadfee(paycash) {
                            this.dialog_roadfee_content = paycash;
                            document.getElementById("Dialog_road_fee").showModal();
                        },
                        closeDialog_roadfee() {
                            document.getElementById("Dialog_road_fee").close();
                        }
                    }
                })

                // console.log(parkingRoad);
                // 在這裡使用 parkingRoad
            })
            .catch(error => console.error(error))

            .then(() => {
                const specialSelect = document.getElementById("special_select");
                specialSelect.addEventListener("change", filterSpecial);

                function filterSpecial() {
                    const parkingItemsS = document.querySelectorAll("#parking_road_item .accordion-item");
                    const valueS = specialSelect.value;

                    parkingItemsS.forEach(item => {
                        const parking = item.querySelector(".parking_name");

                        if (valueS === "disabled" && item.querySelector("#handicapped") === null) {
                            item.style.display = "none";
                        } else if (valueS === "parent" && item.querySelector("#Parent_Child") === null) {
                            item.style.display = "none";
                        } else {
                            item.style.display = "block";
                        }
                    });
                }
            })



    </script>
</body>

</html>